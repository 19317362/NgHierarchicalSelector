angular.module("hierarchical-selector",["hierarchical-selector.tree-item"]).directive("hierarchicalSelector",function(){return{restrict:"E",replace:!0,templateUrl:"hierarchical-selector.tpl.html",scope:{data:"=",multiSelect:"=?",onSelectionChanged:"&",selectOnlyLeafs:"=?",canSelectItem:"&"},link:function(e,t,n){n.canSelectItem&&(e.useCanSelectItemCallback=!0)},controller:function(e,t){function n(){c(),e.$apply()}function c(){e.showTree=!1,o&&(o.isActive=!1,o=void 0),t.off("click",n),t.off("keydown",s)}function i(e,t,n,c){var l=t.indexOf(e);if(l>-1)return{currentArray:t,parentArray:n,parentIndex:c,itemIndex:l};for(var r,a=0;a<t.length&&!(t[a].children&&t[a].children.length>0&&(r=i(e,t[a].children,t,a)));a++);return r}function l(e){var t=e.children[e.children.length-1];return t.isExpanded?l(t):t}function r(e,t,n){var c=i(t,n);if(e){if(t.isExpanded)return t.children[0];if(c.itemIndex<c.currentArray.length-1)return c.currentArray[c.itemIndex+1];if(c.itemIndex==c.currentArray.length-1&&c.parentArray&&c.parentIndex<c.parentArray.length-1)return c.parentArray[c.parentIndex+1]}else{if(c.itemIndex>0){var r=c.currentArray[c.itemIndex-1];return r.isExpanded?l(r):r}if(0===c.itemIndex&&c.parentArray)return c.parentArray[c.parentIndex]}return t}function a(t){o?e.onActiveItem(r(t,o,e.data)):(idx=t?0:e.data.length-1,e.onActiveItem(e.data[idx])),e.$apply()}function s(t){switch(t.keyCode){case 27:t.preventDefault(),t.stopPropagation(),c(),e.$apply();break;case 32:case 13:t.preventDefault(),t.stopPropagation(),o&&(e.itemSelected(o),e.$apply());break;case 40:t.preventDefault(),t.stopPropagation(),a(!0);break;case 38:t.preventDefault(),t.stopPropagation(),a(!1);break;case 37:t.preventDefault(),t.stopPropagation(),o&&(o.isExpanded=!1,e.$apply());break;case 39:t.preventDefault(),t.stopPropagation(),o&&(o.isExpanded=!0,e.$apply())}}var o;e.showTree=!1,e.selectedItems=[],e.multiSelect=e.multiSelect||!1,e.onActiveItem=function(e){o!=e&&(o&&(o.isActive=!1),o=e,o.isActive=!0)},e.deselectItem=function(t,n){n.stopPropagation(),e.selectedItems.splice(e.selectedItems.indexOf(t),1),c(),t.selected=!1,e.onSelectionChanged&&e.onSelectionChanged({items:e.selectedItems.length?e.selectedItems:void 0})},e.onControlClicked=function(c){c.stopPropagation(),e.showTree||(e.showTree=!0,t.on("click",n),t.on("keydown",s))},e.itemSelected=function(t){if(!(e.useCanSelectItemCallback&&e.canSelectItem({item:t})===!1||e.selectOnlyLeafs&&t.children&&t.children.length>0)){if(e.multiSelect){t.selected=!0;var n=e.selectedItems.indexOf(t);n>-1?(t.selected=!1,e.selectedItems.splice(n,1)):e.selectedItems.push(t)}else{c();for(var i=0;i<e.selectedItems.length;i++)e.selectedItems[i].selected=!1;t.selected=!0,e.selectedItems=[],e.selectedItems.push(t)}e.onSelectionChanged&&e.onSelectionChanged({items:e.selectedItems.length?e.selectedItems:void 0})}}}}}),angular.module("hierarchical-selector.tree-item",[]).directive("treeItem",function(e){return{restrict:"E",replace:!0,templateUrl:"tree-item.tpl.html",scope:{item:"=",itemSelected:"&",onActiveItem:"&",multiSelect:"=?",isActive:"=",selectOnlyLeafs:"=?",useCanSelectItem:"=",canSelectItem:"="},controller:function(e){e.item.isExpanded=!1,e.showExpando=function(e){return e.children&&e.children.length>0},e.onExpandoClicked=function(e,t){t.stopPropagation(),e.isExpanded=!e.isExpanded},e.clickSelectItem=function(t,n){n.stopPropagation(),e.itemSelected&&e.itemSelected({item:t})},e.subItemSelected=function(t){e.itemSelected&&e.itemSelected({item:t})},e.activeSubItem=function(t){e.onActiveItem&&e.onActiveItem({item:t})},e.onMouseOver=function(t,n){n.stopPropagation(),e.onActiveItem&&e.onActiveItem({item:t})},e.showCheckbox=function(){return e.multiSelect?e.useCanSelectItem?e.canSelectItem({item:e.item}):!e.selectOnlyLeafs||e.selectOnlyLeafs&&0===e.item.children.length:!1}},compile:function(t,n,c){angular.isFunction(c)&&(c={post:c});var i,l=t.contents().remove();return{pre:c&&c.pre?c.pre:null,post:function(t,n){i||(i=e(l)),i(t,function(e){n.append(e)}),c&&c.post&&c.post.apply(null,arguments)}}}}}),angular.module("hierarchical-selector").run(["$templateCache",function(e){e.put("hierarchical-selector.tpl.html",'<div class="hierarchical-control">\r\n  <div class="hierarchical-input form-control" ng-click="onControlClicked($event)">\r\n    <span ng-if="selectedItems.length > 0" class="selected-items">\r\n      <span ng-repeat="i in selectedItems" class="selected-item">{{i.name}} <span class="selected-item-close" ng-click="deselectItem(i, $event)"></span></span>\r\n    </span>\r\n    <!-- <input type="text" class="blend-in" /> -->\r\n  </div>\r\n  <div class="tree-view" ng-show="showTree">\r\n    <ul>\r\n      <tree-item class="top-level" ng-repeat="item in data" item="item" select-only-leafs="selectOnlyLeafs" use-can-select-item="useCanSelectItemCallback" can-select-item="canSelectItem" multi-select="multiSelect" item-selected="itemSelected(item)" on-active-item="onActiveItem(item)" />\r\n    </ul>\r\n  </div>\r\n</div>\r\n'),e.put("tree-item.tpl.html",'<li>\r\n  <div class="item-container" ng-class="{active: item.isActive, selected: item.selected}" ng-click="clickSelectItem(item, $event)" ng-mouseover="onMouseOver(item, $event)">\r\n    <span ng-if="showExpando(item)" class="expando" ng-class="{\'expando-opened\': item.isExpanded}" ng-click="onExpandoClicked(item, $event)"></span><div class="item-details"><input class="tree-checkbox" type="checkbox" ng-if="showCheckbox()" ng-checked="item.selected" />{{item.name}}</div>\r\n  </div>\r\n  <ul ng-repeat="child in item.children" ng-if="item.isExpanded">\r\n    <tree-item item="child" item-selected="subItemSelected(item)" select-only-leafs="selectOnlyLeafs" use-can-select-item="useCanSelectItem" can-select-item="canSelectItem" multi-select="multiSelect" on-active-item="activeSubItem(item, $event)" />\r\n  </ul>\r\n</li>\r\n')}]);