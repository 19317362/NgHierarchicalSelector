angular.module("hierarchical-selector",["hierarchical-selector.tree-item","hierarchical-selector.selectorUtils"]).directive("hierarchicalSelector",["$compile","selectorUtils",function(e,t){return{restrict:"E",replace:!0,templateUrl:"hierarchical-selector.tpl.html",scope:{syncData:"=data",multiSelect:"=?",onSelectionChanged:"&",selectOnlyLeafs:"=?",canSelectItem:"&",loadChildItems:"&",itemHasChildren:"&"},link:function(e,t,a){if(a.canSelectItem&&(e.useCanSelectItemCallback=!0),a.loadChildItems&&(e.isAsync=!0),!e.syncData&&e.isAsync){e.data=[];var n=e.loadChildItems({parent:null});angular.isArray(n)?e.data=n:n.then(function(t){e.data=t})}e.syncData&&(e.data=e.syncData,e.$watch("syncData",function(){e.data=e.syncData}))},controller:["$scope","$document","$window",function(e,a){function n(){i(),e.$apply()}function i(){if(e.showTree=!1,d){var i=t.getMetaData(d);i.isActive=!1,d=void 0}e.asyncChildCache={},a.off("click",n),a.off("keydown",o)}function c(a,n,i,l){if(n){var s=n.indexOf(a);if(s>-1)return{currentArray:n,parentArray:i,parentIndex:l,itemIndex:s};for(var r,o=0;o<n.length&&(!t.hasChildren(n[o],e.isAsync)||!(r=c(a,t.getChildren(n[o],e.isAsync,e.asyncChildCache),n,o)));o++);return r}}function l(a){var n=t.getChildren(a,e.isAsync,e.asyncChildCache),i=n[n.length-1];return t.getMetaData(i).isExpanded?l(i):i}function s(a,n,i){var s=c(n,i),r=t.getMetaData(n);if(a){if(r.isExpanded)return t.getChildren(n,e.isAsync,e.asyncChildCache)[0];if(s.itemIndex<s.currentArray.length-1)return s.currentArray[s.itemIndex+1];if(s.itemIndex==s.currentArray.length-1&&s.parentArray&&s.parentIndex<s.parentArray.length-1)return s.parentArray[s.parentIndex+1]}else{if(s.itemIndex>0){var o=s.currentArray[s.itemIndex-1];return t.getMetaData(o).isExpanded?l(o):o}if(0===s.itemIndex&&s.parentArray)return s.parentArray[s.parentIndex]}return n}function r(t){d?e.onActiveItem(s(t,d,e.data)):(idx=t?0:e.data.length-1,e.onActiveItem(e.data[idx])),e.$apply()}function o(a){switch(a.keyCode){case 27:a.preventDefault(),a.stopPropagation(),i(),e.$apply();break;case 32:case 13:a.preventDefault(),a.stopPropagation(),d&&(e.itemSelected(d),e.$apply());break;case 40:a.preventDefault(),a.stopPropagation(),r(!0);break;case 38:a.preventDefault(),a.stopPropagation(),r(!1);break;case 37:a.preventDefault(),a.stopPropagation(),d&&(t.getMetaData(d).isExpanded=!1,e.$apply());break;case 39:a.preventDefault(),a.stopPropagation(),d&&(t.getMetaData(d).isExpanded=!0,e.$apply())}}var d;e.showTree=!1,e.selectedItems=[],e.multiSelect=e.multiSelect||!1,e.asyncChildCache={},e.onActiveItem=function(e){if(d!=e){if(d){var a=t.getMetaData(d);a.isActive=!1}d=e;var n=t.getMetaData(d);n.isActive=!0}},e.deselectItem=function(a,n){n.stopPropagation(),e.selectedItems.splice(e.selectedItems.indexOf(a),1),i();var c=t.getMetaData(a);c.selected=!1,e.onSelectionChanged&&e.onSelectionChanged({items:e.selectedItems.length?e.selectedItems:void 0})},e.onControlClicked=function(t){t.stopPropagation(),e.showTree||(e.showTree=!0,a.on("click",n),a.on("keydown",o))},e.itemSelected=function(a){if(!(e.useCanSelectItemCallback&&e.canSelectItem({item:a})===!1||e.selectOnlyLeafs&&t.hasChildren(a,e.isAsync))){var n=t.getMetaData(a);if(e.multiSelect){n.selected=!0;var c=e.selectedItems.indexOf(a);c>-1?(n.selected=!1,e.selectedItems.splice(c,1)):e.selectedItems.push(a)}else{i();for(var l=0;l<e.selectedItems.length;l++)t.getMetaData(e.selectedItems[l]).selected=!1;n.selected=!0,e.selectedItems=[],e.selectedItems.push(a)}e.onSelectionChanged&&e.onSelectionChanged({items:e.selectedItems.length?e.selectedItems:void 0})}}}]}}]),angular.module("hierarchical-selector.selectorUtils",[]).factory("selectorUtils",["$q",function(){return{getMetaData:function(e){return e._hsmeta||(e._hsmeta={}),e._hsmeta},hasChildren:function(e,t){return t?e.hasChildren:e.children&&e.children.length>0},getChildren:function(e,t,a){var n=t?a[e.$$hashKey]:e.children;return t&&!n&&e.hasChildren?[]:n}}}]),angular.module("hierarchical-selector.tree-item",["hierarchical-selector.selectorUtils"]).directive("treeItem",["$compile","$q","selectorUtils",function(e,t,a){return{restrict:"E",replace:!0,templateUrl:"tree-item.tpl.html",scope:{item:"=",itemSelected:"&",onActiveItem:"&",multiSelect:"=?",isActive:"=",selectOnlyLeafs:"=?",useCanSelectItem:"=",canSelectItem:"=",loadChildItems:"=",itemHasChildren:"&",async:"=",asyncChildCache:"="},controller:["$scope",function(e){if(e.metaData=a.getMetaData(e.item),e.metaData.isExpanded=!1,e.async){if(angular.isFunction(e.loadChildItems)&&e.item){var t=e.loadChildItems({parent:e.item});angular.isArray(t)&&(e.theChildren=t),t.then(function(t){e.theChildren=t,e.asyncChildCache[e.item.$$hashKey]=t})}}else e.theChildren=e.item.children;e.showExpando=function(t){return a.hasChildren(t,e.async)},e.onExpandoClicked=function(e,t){t.stopPropagation();var n=a.getMetaData(e);n.isExpanded=!n.isExpanded},e.clickSelectItem=function(t,a){a.stopPropagation(),e.itemSelected&&e.itemSelected({item:t})},e.subItemSelected=function(t){e.itemSelected&&e.itemSelected({item:t})},e.activeSubItem=function(t){e.onActiveItem&&e.onActiveItem({item:t})},e.onMouseOver=function(t){t.stopPropagation(),angular.isFunction(e.onActiveItem)&&e.onActiveItem({item:e.item})},e.showCheckbox=function(){return e.multiSelect?e.useCanSelectItem?e.canSelectItem({item:e.item}):!e.selectOnlyLeafs||e.selectOnlyLeafs&&!a.hasChildren(e.item,e.async):!1}}],compile:function(t,a,n){angular.isFunction(n)&&(n={post:n});var i,c=t.contents().remove();return{pre:n&&n.pre?n.pre:null,post:function(t,a){i||(i=e(c)),i(t,function(e){a.append(e)}),n&&n.post&&n.post.apply(null,arguments)}}}}}]),angular.module("hierarchical-selector").run(["$templateCache",function(e){e.put("hierarchical-selector.tpl.html",'<div class="hierarchical-control">\r\n  <div class="hierarchical-input form-control" ng-click="onControlClicked($event)">\r\n    <span ng-if="selectedItems.length > 0" class="selected-items">\r\n      <span ng-repeat="i in selectedItems" class="selected-item">{{i.name}} <span class="selected-item-close" ng-click="deselectItem(i, $event)"></span></span>\r\n    </span>\r\n    <!-- <input type="text" class="blend-in" /> -->\r\n  </div>\r\n  <div class="tree-view" ng-show="showTree">\r\n    <ul>\r\n      <tree-item class="top-level" ng-repeat="item in data" item="item" select-only-leafs="selectOnlyLeafs" use-can-select-item="useCanSelectItemCallback" can-select-item="canSelectItem" multi-select="multiSelect" item-selected="itemSelected(item)" on-active-item="onActiveItem(item)" load-child-items="loadChildItems" async="isAsync" item-has-children="hasChildren(parent)" async-child-cache="asyncChildCache" />\r\n    </ul>\r\n  </div>\r\n</div>\r\n'),e.put("tree-item.tpl.html",'<li>\r\n  <div class="item-container" ng-class="{active: metaData.isActive, selected: metaData.selected}" ng-mouseover="onMouseOver($event)" ng-click="clickSelectItem(item, $event)">\r\n    <span ng-if="showExpando(item)" class="expando" ng-class="{\'expando-opened\': metaData.isExpanded}" ng-click="onExpandoClicked(item, $event)"></span><div class="item-details"><input class="tree-checkbox" type="checkbox" ng-if="showCheckbox()" ng-checked="metaData.selected" />{{item.name}}</div>\r\n  </div>\r\n  <ul ng-repeat="child in theChildren" ng-if="metaData.isExpanded">\r\n    <tree-item item="child" item-selected="subItemSelected(item)" select-only-leafs="selectOnlyLeafs" use-can-select-item="useCanSelectItem" can-select-item="canSelectItem" multi-select="multiSelect" on-active-item="activeSubItem(item, $event)" load-child-items="loadChildItems" async="async" async-child-cache="asyncChildCache" />\r\n  </ul>\r\n</li>\r\n')}]);